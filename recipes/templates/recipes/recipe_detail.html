{% extends 'recipes/base.html' %}

{% block title %}
<title>{{ recipe.title }}</title>
{% endblock %}

{% block content %}
<div class="p-2 mb-3 bg-body-tertiary rounded-3">
    <div class="container">

        <!-- Titel & Buttons -->
        <div class="d-flex align-items-center mb-3">
            <h4 class="flex-grow-1 mb-0">{{ recipe.title }}</h4>
        </div>
        <div class="d-flex gap-2 mb-2">
            <a
                href="{% url 'recipes:cook' recipe.slug %}?servings={{ current_servings }}"
                class="btn btn-outline-primary me-auto"
            >
                <i class="bi bi-play-fill"></i>
            </a>
            <!-- Wochenplan hinzuf√ºgen Dropdown -->
            <div class="dropdown d-inline">
                <button class="btn btn-outline-primary" type="button" id="addToPlanDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-calendar-event"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="addToPlanDropdown">
                    {% for day in days %}
                        <li>
                            <a class="dropdown-item"
                            href="{% url 'recipes:weekly_plan' %}?action=add&recipe_id={{ recipe.id }}&day={{ day }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}">
                            {{ day }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <!-- <a href="https://todoist.com/add?content={{ '['|add:recipe.title|add:']('|add:request.build_absolute_uri|add:') #WG /Essensplanung'|urlencode }}" target="_blank" class="btn btn-primary">
                <i class="bi bi-box-arrow-up"></i>
            </a> -->
            <a href="{% url 'recipes:update' recipe.slug %}" class="btn btn-outline-success">
                <i class="bi bi-pencil-square"></i>
            </a>
            <a href="{% url 'recipes:delete' recipe.slug %}" class="btn btn-outline-danger">
                <i class="bi bi-trash-fill"></i>
            </a>
        </div>

        <!-- Wenn ein externer Link vorhanden ist, zeige nur Titel und externen Link -->
        {% if recipe.external_link %}
        <div class="mb-3">
            <a href="{{recipe.external_link}}" class="btn btn-outline-primary btn-sm mb-3" target="_blank">
                Externer Link: {{ recipe.external_link }}
            </a>
        </div>
        {% else %}
            <!-- Bild -->
            {% if recipe.image %}
            <div class="recipe-hero mb-4">
                <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
            </div>
            {% endif %}

            <!-- Labels -->
             {% if recipe.labels.all %}
            <div class="mb-4">
                {% for label in recipe.labels.all %}
                    <span class="chip chip-{{ label.label_type }}">
                        {{ label.name }}
                    </span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Dauer & Temperatur -->
            <div class="row g-3 mb-4">
                {% if recipe.duration_minutes %}
                <div class="col-6 col-md-4">
                    <div class="info-tile">
                        ‚è±Ô∏è <strong>{{ recipe.duration_minutes }}</strong>
                        <small>Min Gesamt</small>
                    </div>
                </div>
                {% endif %}

                {% if recipe.working_time %}
                <div class="col-6 col-md-4">
                    <div class="info-tile">
                        ‚úã <strong>{{ recipe.working_time }}</strong>
                        <small>Min Arbeit</small>
                    </div>
                </div>
                {% endif %}

                {% if recipe.temperature_celsius %}
                <div class="col-12 col-md-4">
                    <div class="info-tile">
                        üî• <strong>{{ recipe.temperature_celsius }}¬∞C</strong>
                        <small>Ober-/Unterhitze</small>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- üç≥ Koch-Counter -->
             <div class="action-bar mb-4">
                <form method="post" class="d-flex gap-2 mb-0">
                    {% csrf_token %}
                    <button type="submit" name="cooked" class="btn btn-ios btn-sm">
                        üç≥ Gekocht
                    </button>
                    {% if recipe.cooked_count > 0 %}
                    <button type="submit" name="undo_cooked" class="btn btn-ios-secondary btn-sm">
                        R√ºckg√§ngig
                    </button>
                    {% endif %}
                </form>

                <span class="text-muted">üç≥ {{ recipe.cooked_count }}√ó</span>
            </div>

            <!-- <div class="mb-3 p-2 border rounded d-flex flex-wrap align-items-center gap-2">
                <form method="post" class="d-flex align-items-center gap-2 mb-0">
                    {% csrf_token %}
                    <button type="submit" name="cooked" class="btn btn-success btn-sm">Habe ich gekocht</button>
                    {% if recipe.cooked_count > 0 %}
                        <button type="submit" name="undo_cooked" class="btn btn-secondary btn-sm">R√ºckg√§ngig</button>
                    {% endif %}
                </form>
                <span class="text-muted ms-auto">üç≥ {{ recipe.cooked_count }} mal gekocht</span>
            </div> -->

            <!-- Portionsauswahl -->
            <div class="mb-3">
                <label class="form-label"><strong>Portionen:</strong></label>
                <div class="input-group" style="max-width: 125px;">
                    <button class="btn btn-outline-secondary" id="minus-btn" type="button">‚àí</button>
                    <input type="number" id="servings-input" class="form-control text-center" value="{{ current_servings }}" min="1">
                    <button class="btn btn-outline-secondary" id="plus-btn" type="button">+</button>
                </div>
                <small class="text-muted">Basisrezept f√ºr {{ base_servings }} Portionen</small>
            </div>

            <!-- Zutaten -->
            {% if recipe.ingredients %}
            <h3>Zutaten</h3>
            <ul class="list-group list-group-flush" id="ingredients-list">
                {% for ingredient in ingredients_list %}
                    <li class="list-group-item ingredient-item" data-original="{{ ingredient }}">
                        <span>{{ ingredient }}</span>
                    </li>
                {% endfor %}
            </ul>
            <br>
            {% endif %}

            <!-- Zubereitungsschritte -->
            {% if recipe.steps %}
            <h3>Zubereitungsschritte</h3>
            <ol class="list-group list-group-numbered">
                {% for step in steps_list %}
                    <li class="list-group-item">{{ step }}</li>
                {% endfor %}
            </ol>
            {% endif %}
        {% endif %}

    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const minusBtn = document.getElementById("minus-btn");
    const plusBtn = document.getElementById("plus-btn");
    const servingsInput = document.getElementById("servings-input");
    const ingredientsList = document.querySelectorAll("#ingredients-list .ingredient-item");

    const baseServings = parseFloat("{{ base_servings }}");

    function updateIngredients() {
        const currentServings = parseFloat(servingsInput.value) || baseServings;
        const factor = currentServings / baseServings;

        ingredientsList.forEach(item => {
            const original = item.dataset.original.trim();
            const match = original.match(/^([\d.,/]+)\s*(.*)$/);
            if (match) {
                let amountStr = match[1].replace(",", ".");
                let rest = match[2];

                let amount = parseFloat(amountStr);
                if (isNaN(amount) && amountStr.includes("/")) {
                    const parts = amountStr.split("/");
                    if (parts.length === 2) amount = parseFloat(parts[0])/parseFloat(parts[1]);
                }

                item.querySelector("span").textContent = !isNaN(amount) ? (Math.round(amount * factor * 100)/100) + " " + rest : original;
            } else {
                item.querySelector("span").textContent = original;
            }
        });
    }

    minusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        if (value > 1) {
            servingsInput.value = value - 1;
            updateIngredients();
        }
    });

    plusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        servingsInput.value = value + 1;
        updateIngredients();
    });

    servingsInput.addEventListener("input", updateIngredients);

    // Initiales Update
    updateIngredients();
});
</script>


</div>
{% endblock %}
