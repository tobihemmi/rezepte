{% extends 'recipes/base.html' %}

{% block title %}
<title>{{ recipe.title }}</title>
{% endblock %}

{% block content %}
<div class="p-2 mb-3 bg-body-tertiary rounded-3">
    <div class="container">

        <!-- Titel & Buttons -->
        <div class="d-flex align-items-center mb-3">
            <h4 class="flex-grow-1 mb-0">{{ recipe.title }}</h4>
        </div>
        <div class="d-flex justify-content-end gap-2 mb-2">
            <!-- Wochenplan hinzuf√ºgen Dropdown -->
            <div class="dropdown d-inline">
                <button class="btn btn-success dropdown-toggle" type="button" id="addToPlanDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-calendar-event"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="addToPlanDropdown">
                    {% for day in days %}
                        <li>
                            <a class="dropdown-item"
                            href="{% url 'recipes:weekly_plan' %}?action=add&recipe_id={{ recipe.id }}&day={{ day }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}">
                            {{ day }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <a href="https://todoist.com/add?content={{ '['|add:recipe.title|add:']('|add:request.build_absolute_uri|add:') #WG /Essensplanung'|urlencode }}" target="_blank" class="btn btn-primary">
                <i class="bi bi-box-arrow-up"></i>
            </a>
            <a href="{% url 'recipes:update' recipe.slug %}" class="btn btn-success">
                <i class="bi bi-pencil-square"></i>
            </a>
            <a href="{% url 'recipes:delete' recipe.slug %}" class="btn btn-danger">
                <i class="bi bi-trash-fill"></i>
            </a>
        </div>

        <!-- Bild -->
        {% if recipe.image %}
        <div class="recipe-image-wrapper text-center mb-4">
            <img src="{{ recipe.image.url }}" class="img-fluid rounded recipe-image" alt="{{ recipe.title }}">
        </div>
        {% endif %}

        <!-- Dauer & Temperatur -->
        {% if recipe.duration_minutes %}<p><strong>Gesamtdauer:</strong> {{ recipe.duration_minutes }} Minuten</p>{% endif %}
        {% if recipe.working_time %}<p><strong>Arbeitsdauer:</strong> {{ recipe.working_time }} Minuten</p>{% endif %}
        {% if recipe.temperature_celsius %}<p><strong>Temperatur:</strong> {{ recipe.temperature_celsius }} ¬∞C Ober-/Unterhitze</p>{% endif %}

        <!-- Labels -->
        {% if recipe.labels.all %}
        <p><strong>Labels:</strong>
            {% for label in recipe.labels.all %}
                {% if label.label_type == "category" %}
                    <span class="badge rounded-pill border text-primary">{{ label.name }}</span>
                {% elif label.label_type == "event" %}
                    <span class="badge rounded-pill border text-success">{{ label.name }}</span>
                {% else %}
                    <span class="badge rounded-pill border text-secondary">{{ label.name }}</span>
                {% endif %}
            {% endfor %}
        </p>
        {% endif %}

        <!-- üç≥ Koch-Counter -->
        <div class="mb-3 p-2 border rounded d-flex flex-wrap align-items-center gap-2">
            <form method="post" class="d-flex align-items-center gap-2 mb-0">
                {% csrf_token %}
                <button type="submit" name="cooked" class="btn btn-success btn-sm">Habe ich gekocht</button>
                {% if recipe.cooked_count > 0 %}
                    <button type="submit" name="undo_cooked" class="btn btn-secondary btn-sm">R√ºckg√§ngig</button>
                {% endif %}
            </form>
            <span class="text-muted ms-auto">üç≥ {{ recipe.cooked_count }} mal gekocht</span>
        </div>

        <!-- Portionsauswahl -->
        <div class="mb-3">
            <label class="form-label"><strong>Portionen:</strong></label>
            <div class="input-group" style="max-width: 200px;">
                <button class="btn btn-outline-secondary" id="minus-btn" type="button">‚àí</button>
                <input type="number" id="servings-input" class="form-control text-center" value="{{ current_servings }}" min="1">
                <button class="btn btn-outline-secondary" id="plus-btn" type="button">+</button>
            </div>
            <small class="text-muted">Basisrezept f√ºr {{ base_servings }} Portionen</small>
        </div>

        <!-- Kochmodus-Link -->
        <a id="cook-link" href="{% url 'recipes:cook' recipe.slug %}?servings={{ current_servings }}" class="btn btn-outline-primary btn-sm mb-3">
            Kochmodus starten
        </a>

        <!-- Zutaten -->
        {% if recipe.ingredients %}
        <h3>Zutaten</h3>
        <ul class="list-group list-group-flush" id="ingredients-list">
            {% for ingredient in ingredients_list %}
                <li class="list-group-item ingredient-item" data-original="{{ ingredient }}">
                    {{ ingredient }}
                </li>
            {% endfor %}
        </ul>
        <br>
        {% endif %}

        <!-- Zubereitungsschritte -->
        {% if recipe.steps %}
        <h3>Zubereitungsschritte</h3>
        <ol class="list-group list-group-numbered">
            {% for step in steps_list %}
                <li class="list-group-item">{{ step }}</li>
            {% endfor %}
        </ol>
        {% endif %}

    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const servingsInput = document.getElementById("servings-input");
    const cookLink = document.getElementById("cook-link");
    const minusBtn = document.getElementById("minus-btn");
    const plusBtn = document.getElementById("plus-btn");
    const ingredientsList = document.querySelectorAll("#ingredients-list .ingredient-item");
    const baseServings = parseInt("{{ base_servings }}", 10);

    function updateCookLink() {
        const val = parseInt(servingsInput.value) || baseServings;
        cookLink.href = "{% url 'recipes:cook' recipe.slug %}?servings=" + val;
    }

    function updateIngredients() {
        const currentServings = parseFloat(servingsInput.value) || baseServings;
        const factor = currentServings / baseServings;

        ingredientsList.forEach(item => {
            const original = item.dataset.original.trim();
            const match = original.match(/^([\d.,/]+)\s*(.*)$/);
            if (match) {
                let amountStr = match[1].replace(",", ".");
                let rest = match[2];

                let amount = parseFloat(amountStr);
                if (isNaN(amount) && amountStr.includes("/")) {
                    const parts = amountStr.split("/");
                    if (parts.length === 2) amount = parseFloat(parts[0])/parseFloat(parts[1]);
                }

                item.textContent = !isNaN(amount) ? (Math.round(amount * factor * 100)/100) + " " + rest : original;
            } else {
                item.textContent = original;
            }
        });
    }
    // Events
    servingsInput.addEventListener("input", function() {
        updateCookLink();
        updateIngredients();
    });
    minusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        if (value > 1) { servingsInput.value = value-1; updateCookLink(); updateIngredients(); }
    });
    plusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        servingsInput.value = value+1; updateCookLink(); updateIngredients();
    });

    // Initiales Update
    updateCookLink();
    updateIngredients();
});
</script>
</div>
{% endblock %}

