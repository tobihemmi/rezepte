{% extends 'recipes/base.html' %}
{% load static %}
{% block title %}
<title>{{ recipe.title }}</title>
{% endblock %}

{% block content %}
<div class="p-2 mb-3 bg-body-tertiary rounded-3">
    <div class="container">

        <!-- Titel & Buttons -->
        <div class="d-flex align-items-center mb-3">
            <h4 class="flex-grow-1 mb-0">{{ recipe.title }}</h4>
        </div>

        <!-- Wenn ein externer Link vorhanden ist, zeige nur Titel und externen Link -->

        {% if recipe.image %}
        <div class="recipe-hero mb-4 position-relative">
            <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="img-fluid rounded">

            <!-- Buttons √ºber dem Bild -->
            
            <div class="position-absolute top-0 start-0 w-100 d-flex gap-2 p-2">
                {% if not recipe.external_link %}
                <a href="{% url 'recipes:cook' recipe.slug %}?servings={{ current_servings }}" class="btn btn-ios me-auto">
                    <i class="bi bi-play-fill"></i>
                </a>
                {% endif %}
                <!-- Kalender Dropdown -->
                <div class="dropdown d-inline">
                    <button class="btn btn-ios calendar-dropdown" type="button" id="addToPlanDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-calendar-event"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="addToPlanDropdown">
                        {% for day in days %}
                        <li>
                            <a class="dropdown-item" href="{% url 'recipes:weekly_plan' %}?action=add&recipe_id={{ recipe.id }}&day={{ day }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}">
                                {{ day }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <a href="{% url 'recipes:update' recipe.slug %}" class="btn btn-ios-secondary">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a href="{% url 'recipes:delete' recipe.slug %}" class="btn btn-ios-danger">
                    <i class="bi bi-trash-fill"></i>
                </a>
            </div>
        </div>

        {% else %}
         <div class="d-flex gap-2 mb-2">
            {% if not recipe.external_link %}
            <a href="{% url 'recipes:cook' recipe.slug %}?servings={{ current_servings }}" class="btn btn-ios me-auto">
                <i class="bi bi-play-fill"></i>
            </a>
            {% endif %}

            <div class="dropdown d-inline">
                <button class="btn btn-ios" type="button" id="addToPlanDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-calendar-event"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="addToPlanDropdown">
                    {% for day in days %}
                        <li>
                            <a class="dropdown-item" href="{% url 'recipes:weekly_plan' %}?action=add&recipe_id={{ recipe.id }}&day={{ day }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}">
                                {{ day }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <a href="{% url 'recipes:update' recipe.slug %}" class="btn btn-ios-secondary">
                <i class="bi bi-pencil-square"></i>
            </a>
            <a href="{% url 'recipes:delete' recipe.slug %}" class="btn btn-ios-danger">
                <i class="bi bi-trash-fill"></i>
            </a>
        </div>
        {% endif %}

        {% if recipe.external_link %}
        <div class="mb-3">
            <a href="{{recipe.external_link}}" class="btn btn-outline-primary btn-sm mb-3 text-truncate d-block" target="_blank" style="max-width: 100%;">
                Externer Link: {{ recipe.external_link }}
            </a>
        </div>

        {% else %}

            <!-- Labels -->
             {% if recipe.labels.all %}
            <div class="mb-4">
                {% for label in recipe.labels.all %}
                    <span class="chip chip-{{ label.label_type }}">
                        {{ label.name }}
                    </span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Dauer & Temperatur -->
            <div class="row g-3 mb-4">
                {% if recipe.duration_minutes %}
                <div class="col-4">
                    <div class="info-tile p-2 small">
                        ‚è±Ô∏è <strong class="d-block fs-6">{{ recipe.duration_minutes }}</strong>
                        <small>Min Gesamt</small>
                    </div>
                </div>

                {% endif %}

                {% if recipe.working_time %}
                <div class="col-4">
                <div class="info-tile p-2 small">
                    ‚úã <strong class="d-block fs-6">{{ recipe.working_time }}</strong>
                    <small>Min Arbeit</small>
                </div>
                </div>
                {% endif %}

                {% if recipe.temperature_celsius %}
                <div class="col-4">
                <div class="info-tile p-2 small">
                    üî• <strong class="d-block fs-6">{{ recipe.temperature_celsius }}</strong>
                    <small>Ober-/Unterh.</small>
                </div>
                </div>
                {% endif %}
            </div>

            <!-- üç≥ Koch-Counter -->
             <div class="action-bar mb-4">
                <form method="post" class="d-flex gap-2 mb-0">
                    {% csrf_token %}
                    <button type="submit" name="cooked" class="btn btn-ios btn-sm">
                        üç≥ Gekocht
                    </button>
                    {% if recipe.cooked_count > 0 %}
                    <button type="submit" name="undo_cooked" class="btn btn-ios-secondary btn-sm">
                        R√ºckg√§ngig
                    </button>
                    {% endif %}
                </form>

                <span class="text-muted">üç≥ {{ recipe.cooked_count }}√ó</span>
            </div>

            <div class="mb-3">
                <!-- Label √ºber dem Stepper -->
                <label class="form-label fw-semibold d-block mb-2">Portionen</label>

                <!-- Stepper Buttons + Input -->
                <div class="servings-stepper d-inline-flex mb-2">
                    <button id="minus-btn" type="button">‚àí</button>
                    <input type="number" id="servings-input" value="{{ current_servings }}" min="1">
                    <button id="plus-btn" type="button">+</button>
                </div>

                <!-- Hinweis unter Stepper -->
                <small class="text-muted d-block">
                    Basisrezept f√ºr {{ base_servings }} Portionen
                </small>
            </div>

            {% if recipe.ingredients %}
            <div itemscope itemtype="https://schema.org/Recipe">

                <meta itemprop="name" content="{{ recipe.title }}">
                <meta itemprop="url" content="{{ request.build_absolute_uri }}">
                <meta itemprop="recipeYield" content="{{ base_servings }}">

                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h3 class="section-title mb-0">Zutaten</h3>

                    <a id="bring-export-btn"
                    href="#"
                    class="btn btn-ios d-flex align-items-center gap-1"
                    title="Zu Bring! exportieren">
                        <i class="bi bi-cart"></i>
                    </a>
                </div>

                <ul class="list-group list-group mb-4 shadow-sm" id="ingredients-list">
                    {% for ingredient in ingredients_list %}
                        <li class="list-group-item ingredient-item"
                            itemprop="recipeIngredient"
                            data-original="{{ ingredient }}">
                            {{ ingredient }}
                        </li>
                    {% endfor %}
                </ul>

            </div>

            {% endif %} 

            <!-- Zubereitungsschritte -->
             {% if recipe.steps %}
            <h3 class="section-title">Zubereitung</h3>
            <ol class="list-group list-group-numbered shadow-sm">
                {% for step in steps_list %}
                    <li class="list-group-item">{{ step }}</li>
                {% endfor %}
            </ol>
            {% endif %}
        {% endif %}

    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const minusBtn = document.getElementById("minus-btn");
    const plusBtn = document.getElementById("plus-btn");
    const servingsInput = document.getElementById("servings-input");
    const ingredientsList = document.querySelectorAll("#ingredients-list .ingredient-item");

    const baseServings = parseFloat("{{ base_servings }}");

    function updateIngredients() {
        const currentServings = parseFloat(servingsInput.value) || baseServings;
        const factor = currentServings / baseServings;

        ingredientsList.forEach(item => {
            const original = item.dataset.original.trim();
            const match = original.match(/^([\d.,/]+)\s*(.*)$/);

            if (match) {
                let amountStr = match[1].replace(",", ".");
                let rest = match[2];

                let amount = parseFloat(amountStr);
                if (isNaN(amount) && amountStr.includes("/")) {
                    const parts = amountStr.split("/");
                    if (parts.length === 2) {
                        amount = parseFloat(parts[0]) / parseFloat(parts[1]);
                    }
                }

                item.textContent = !isNaN(amount)
                    ? (Math.round(amount * factor * 100) / 100) + " " + rest
                    : original;
            } else {
                item.textContent = original;
            }
        });
    }

    minusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        if (value > 1) {
            servingsInput.value = value - 1;
            updateIngredients();
        }
    });

    plusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        servingsInput.value = value + 1;
        updateIngredients();
    });

    servingsInput.addEventListener("input", updateIngredients);

    // Initiales Update
    updateIngredients();
});

document.addEventListener("DOMContentLoaded", function() {

    const bringBtn = document.getElementById("bring-export-btn");
    if (!bringBtn) return;

    const baseServings = parseFloat("{{ base_servings }}");
    const servingsInput = document.getElementById("servings-input");

    function updateBringLink() {
        const requestedServings = parseInt(servingsInput.value) || baseServings;

        const recipeUrl = encodeURIComponent(window.location.href);

        const bringUrl =
            "https://api.getbring.com/rest/bringrecipes/deeplink" +
            "?url=" + recipeUrl +
            "&source=web" +
            "&baseQuantity=" + baseServings +
            "&requestedQuantity=" + requestedServings;

        bringBtn.href = bringUrl;
    }

    servingsInput.addEventListener("input", updateBringLink);
    updateBringLink();
});

</script>


</div>
{% endblock %}
