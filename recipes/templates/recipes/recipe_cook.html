{% extends 'recipes/base.html' %}

{% block title %}
<title>{{ recipe.title }} - Kochmodus</title>
{% endblock %}

{% block content %}
<!-- Kochmodus Container direkt mit Hintergrund -->
<div class="bg-lightblue py-3">

    <div class="container">

        <!-- Badge am Titel -->
        <div class="d-flex align-items-center mb-3">
            <h3 class="flex-grow-1 mb-0">{{ recipe.title }}</h3>
            <span class="badge bg-info text-white ms-2">Kochmodus üç≥</span>
        </div>

        <!-- Bild -->
        {% if recipe.image %}
        <div class="recipe-image-wrapper text-center mb-4">
            <img src="{{ recipe.image.url }}" class="img-fluid rounded recipe-image" alt="{{ recipe.title }}">
        </div>
        {% endif %}

        <!-- Labels -->
        {% if recipe.labels.all %}
        <div class="mb-4">
            {% for label in recipe.labels.all %}
                <span class="chip chip-{{ label.label_type }}">
                    {{ label.name }}
                </span>
            {% endfor %}
        </div>
        {% endif %}

       <!-- Dauer & Temperatur -->
        <div class="row g-3 mb-4">
            {% if recipe.duration_minutes %}
            <div class="col-4">
                <div class="info-tile p-2 small">
                    ‚è±Ô∏è <strong class="d-block fs-6">{{ recipe.duration_minutes }}</strong>
                    <small>Min Gesamt</small>
                </div>
            </div>

            {% endif %}

            {% if recipe.working_time %}
            <div class="col-4">
            <div class="info-tile p-2 small">
                ‚úã <strong class="d-block fs-6">{{ recipe.working_time }}</strong>
                <small>Min Arbeit</small>
            </div>
            </div>
            {% endif %}

            {% if recipe.temperature_celsius %}
            <div class="col-4">
            <div class="info-tile p-2 small">
                üî• <strong class="d-block fs-6">{{ recipe.temperature_celsius }}</strong>
                <small>Ober-/Unterh.</small>
            </div>
            </div>
            {% endif %}
        </div>


        <!-- Portionsauswahl -->
        <div class="mb-3">
            <!-- Label √ºber dem Stepper -->
            <label class="form-label fw-semibold d-block mb-2">Portionen</label>

            <!-- Stepper Buttons + Input -->
            <div class="servings-stepper d-inline-flex mb-2">
                <button id="minus-btn" type="button">‚àí</button>
                <input type="number" id="servings-input" value="{{ current_servings }}" min="1">
                <button id="plus-btn" type="button">+</button>
            </div>

            <!-- Hinweis unter Stepper -->
            <small class="text-muted d-block">
                Basisrezept f√ºr {{ base_servings }} Portionen
            </small>
        </div>

        <!-- Zutaten mit Checkboxen -->
        {% if recipe.ingredients %}
        <h5>Zutaten</h5>
        <ul class="list-group mb-4" id="ingredients-list">
            {% for ingredient in ingredients_list %}
                <li class="list-group-item d-flex align-items-start ingredient-item shadow-sm" data-original="{{ ingredient }}">
                    <input type="checkbox" class="form-check-input me-2 mt-1 ingredient-checkbox">
                    <span>{{ ingredient }}</span>
                </li>
            {% endfor %}
        </ul>
        {% endif %}

        <!-- Zubereitungsschritte mit Checkboxen -->
        {% if recipe.steps %}
        <h5>Zubereitungsschritte</h5>
        <ul class="list-group">
            {% for step in steps_list %}
                <li class="list-group-item d-flex align-items-start shadow-sm">
                    <input type="checkbox" class="form-check-input me-2 mt-1 step-checkbox">
                    <span class="step-number me-2">{{ forloop.counter }}.</span>
                    <span>{{ step }}</span>
                </li>
            {% endfor %}
        </ul>
        {% endif %}

        <div class="action-bar mb-4 mt-4">
            <form method="post" class="d-flex gap-2 mb-0">
                {% csrf_token %}
                <button type="submit" name="cooked" class="btn btn-ios btn-sm">
                    Fertig
                </button>
                <button type="submit" name="back" class="btn btn-ios-secondary btn-sm">
                    Zur√ºck
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const minusBtn = document.getElementById("minus-btn");
    const plusBtn = document.getElementById("plus-btn");
    const servingsInput = document.getElementById("servings-input");
    const ingredientsList = document.querySelectorAll("#ingredients-list .ingredient-item");

    const baseServings = parseFloat("{{ base_servings }}");

    function updateIngredients() {
        const currentServings = parseFloat(servingsInput.value) || baseServings;
        const factor = currentServings / baseServings;

        ingredientsList.forEach(item => {
            const original = item.dataset.original.trim();
            const match = original.match(/^([\d.,/]+)\s*(.*)$/);
            if (match) {
                let amountStr = match[1].replace(",", ".");
                let rest = match[2];

                let amount = parseFloat(amountStr);
                if (isNaN(amount) && amountStr.includes("/")) {
                    const parts = amountStr.split("/");
                    if (parts.length === 2) amount = parseFloat(parts[0])/parseFloat(parts[1]);
                }

                item.querySelector("span").textContent = !isNaN(amount) ? (Math.round(amount * factor * 100)/100) + " " + rest : original;
            } else {
                item.querySelector("span").textContent = original;
            }
        });
    }

    minusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        if (value > 1) {
            servingsInput.value = value - 1;
            updateIngredients();
        }
    });

    plusBtn.addEventListener("click", function() {
        let value = parseInt(servingsInput.value) || baseServings;
        servingsInput.value = value + 1;
        updateIngredients();
    });

    servingsInput.addEventListener("input", updateIngredients);

    // Initiales Update
    updateIngredients();
});
</script>

<style>
/* Hintergrund f√ºr den gesamten Kochmodus */
.bg-lightblue {
    background-color: #e6f2ff;
}
</style>
{% endblock %}
